name: Build OranGy Browser

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine qtwebchannel qtpositioning'

    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Generate Project File
      shell: pwsh
      run: |
        # Creamos el archivo .pro optimizado para procesar el MOC correctamente
        $pro = @"
        QT += core gui widgets webenginewidgets webchannel positioning
        TEMPLATE = app
        TARGET = OranGyBrowser
        
        # Truco: Ponemos el .cpp en HEADERS para que el MOC lo escanee
        SOURCES += Orangy.cpp
        HEADERS += Orangy.cpp
        
        CONFIG += c++17
        CONFIG += qt
        # Evita el error de WinMain usando consola para debug
        CONFIG += console
        "@
        $pro | Out-File -FilePath OranGy.pro -Encoding utf8

    - name: Build Application
      shell: pwsh
      run: |
        qmake OranGy.pro -spec win32-msvc
        # Forzamos la ejecución de MOC antes de nmake
        nmake /f Makefile.Release clean
        nmake /f Makefile.Release

    - name: Package Release
      shell: pwsh
      run: |
        mkdir dist
        if (Test-Path "release\OranGyBrowser.exe") {
            copy release\OranGyBrowser.exe dist\
            windeployqt --webengine --no-translations dist\OranGyBrowser.exe
        } else {
            Write-Error "No se encontró el ejecutable en release\"
            exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OranGyBrowser-Windows
        path: dist/
