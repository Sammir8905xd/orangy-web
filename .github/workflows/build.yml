name: Build OranGy Browser

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine qtwebchannel qtpositioning'

    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Generate Project File
      shell: pwsh
      run: |
        # Creamos el archivo .pro optimizado
        # Eliminamos la necesidad de incluir manualmente el .moc al final del CPP
        $pro = @"
        QT += core gui widgets webenginewidgets webchannel
        TEMPLATE = app
        TARGET = OranGyBrowser
        SOURCES += Orangy.cpp
        CONFIG += c++17
        # Esto le dice a Qt que maneje autom√°ticamente los archivos MOC
        CONFIG += qt
        "@
        $pro | Out-File -FilePath OranGy.pro -Encoding utf8

    - name: Build Application
      shell: pwsh
      run: |
        qmake OranGy.pro -spec win32-msvc
        nmake /f Makefile.Release

    - name: Package Release
      shell: pwsh
      run: |
        mkdir dist
        copy release\OranGyBrowser.exe dist\
        windeployqt --webengine --no-translations dist\OranGyBrowser.exe

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OranGyBrowser-Windows
        path: dist/
